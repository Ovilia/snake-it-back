!function(){function e(e,i,a){var r=a?game.colorSnakeDead:game.colorSnake;!function(e,i,a){for(var r=0;r<i.length;++r){var o=t(i[r]);"function"==typeof a?a(o[0],o[1],game.gridSize):e.fillRect(o[0],o[1],game.gridSize,game.gridSize)}}(e,i,function(i,t){e.fillStyle=r,e.fillRect(i,t,game.gridSize,game.gridSize),e.fillStyle=game.colorGrass;e.fillRect(i+2,t+2,game.gridSize-4,game.gridSize-4),e.fillStyle=r,e.fillRect(i+4,t+4,game.gridSize-8,game.gridSize-8)})}function i(e,i){e.fillStyle=game.colorFood;!function(e,i,a,r,o,n){a=t(a);for(var g=game.gridSize*r,m=0;m<i.length;++m)e.fillRect(a[0]+i[m][0]*g+o*r,a[1]+i[m][1]*g+n*r,g,g)}(e,[[2,0],[3,0],[4,0],[8,0],[9,0],[10,0],[1,1],[5,1],[7,1],[11,1],[0,2],[3,2],[6,2],[9,2],[12,2],[0,3],[2,3],[3,3],[4,3],[8,3],[9,3],[10,3],[12,3],[0,4],[3,4],[4,4],[5,4],[7,4],[8,4],[9,4],[12,4],[1,5],[4,5],[5,5],[6,5],[7,5],[8,5],[11,5],[2,6],[5,6],[6,6],[7,6],[10,6],[3,7],[6,7],[9,7],[4,8],[8,8],[5,9],[7,9],[6,10]],i,1/12,0,1/12)}function t(e){return[(e[0]+game.marginGrids)*game.gridSize,(e[1]+game.marginGrids)*game.gridSize]}function a(e,i,t,a){this.body=[];for(var r=0;r<t;++r)this.body.push([e>20?e+r:e-t+1-r,i]);this.direction=e>game.insideGridWidth/2?0:2,this._growNextTick=!1,this._skippedFrames=0,this._skipFramePeriod=1/a,this.totalFrames=0,this.food=null,this.heart=null,this.history={}}function r(){document.getElementById("score").innerHTML=game.gameScore+game.roundScore,document.getElementById("heart").innerHTML=game.heartScore}function o(){var e=document.getElementById("count-down");e.innerHTML="3",setTimeout(function(){e.innerHTML="2"},1e3),setTimeout(function(){e.innerHTML="1"},2e3),setTimeout(function(){e.innerHTML=""},3e3)}var n;function g(){++game.round,game.roundScore=0,game.roundFrames=0,r();var e=h(4);game.snake=new a(e[0],e[1],3,.05,game),d(!0),game.status=1,m()}function m(){if(1===game.status){if(null!==game.snake.heartTimeout&&(--game.snake.heartTimeout,0===game.snake.heartTimeout&&(game.snake.heart=null,game.snake.heartTimeout=null)),game.snake.tick(),game.snake.checkCollision())return game.status=2,console.log("collision"),game.gameScore+=game.roundScore,game.roundScore=0,--game.heartScore,r(),0===game.heartScore?void console.log("game over"):(o(),game.historySnakes.push(game.snake.getHistory()),void setTimeout(function(){g()},3e3));var i;game.snake.checkScore(game.snake.food)?(game.roundScore=game.roundScore>0?2*game.roundScore:1,console.log("eat!",game.gameScore),r(),game.snake.speedUp(),d(!1)):game.snake.checkScore(game.snake.heart)&&(game.heartScore=Math.min(game.heartScore+1,game.maxHeartScore),game.snake.heart=null,r()),(i=game.ctx).clearRect(0,0,game.width,game.height),i.fillStyle=game.colorGrass,i.fillRect(game.marginGrids*game.gridSize,game.marginGrids*game.gridSize,game.insideWidth,game.insideHeight),function(){for(var i=game.ctx,t=game.snake.totalFrames,a=0;a<game.historySnakes.length;++a){for(var r,o=game.historySnakes[a],n=o.keys,g=1;g<n.length;++g)if(n[g]>t){r=o.items[n[g-1]];break}r&&e(game.ctx,r,!0)}i.globalAlpha=1}(),game.snake.render(i),requestAnimationFrame(m)}}function s(e){var i;e.keyCode>36&&e.keyCode<41?i=e.keyCode-37:65===e.keyCode?i=0:87===e.keyCode?i=1:68===e.keyCode?i=2:88===e.keyCode&&(i=3),null!=i&&2!==Math.abs(i-game.snake.direction)&&(game.snake.direction=i)}function d(e){game.snake.food=h(),game.roundScore>16&&Math.random()>.9&&(e||!game.snake.heart)?(game.snake.heart=h(),game.snake.heartTimeout=60*(game.roundScore>16?8:20)):e&&(game.snake.heart=null,game.snake.heartTimeout=null)}function h(e){return[(e=e||0)+Math.floor(Math.random()*(game.insideGridWidth-2*e)),e+Math.floor(Math.random()*(game.insideGridHeight-2*e))]}a.prototype.tick=function(){if(++this.totalFrames,++this._skippedFrames,this._skippedFrames<this._skipFramePeriod)return!1;console.log("tick");var e,i=this.body[0];return 1===this.direction&&(e=[i[0],i[1]-1]),2===this.direction&&(e=[i[0]+1,i[1]]),3===this.direction&&(e=[i[0],i[1]+1]),0===this.direction&&(e=[i[0]-1,i[1]]),this.body.splice(0,0,e),console.log(this.body[0]),this._growNextTick||(this.body.splice(this.body.length-1,1),console.log(this.body[0])),this._growNextTick=!1,this._recordHistory(),this._skippedFrames=0,!0},a.prototype.render=function(t){(1===game.status||2===game.status&&Math.floor(this.totalFrames/10)%2==0)&&e(t,this.body,!1),t.fillStyle=game.colorFood;var a=[(this.food[0]+.5+game.marginGrids)*game.gridSize,(this.food[1]+.5+game.marginGrids)*game.gridSize];t.fillRect(a[0]-3,a[1]-9,6,6),t.fillRect(a[0]-3,a[1]+3,6,6),t.fillRect(a[0]-9,a[1]-3,6,6),t.fillRect(a[0]+3,a[1]-3,6,6),t.fillStyle=game.colorGrass;t.fillRect(a[0]-9,a[1]-.5,18,1),t.fillRect(a[0]-.5,a[1]-9,1,18),this.heart&&(this.heartTimeout>300||Math.floor(this.totalFrames/10)%2==0)&&i(t,this.heart)},a.prototype.checkScore=function(e){if(!e)return!1;var i=this.body[0];return!(i[0]!==e[0]||i[1]!=e[1])&&(console.log(i,e),this._growNextTick=!0,!0)},a.prototype.checkCollision=function(){var e=this.body[0];if(e[0]<0||e[0]>=game.insideGridWidth||e[1]<0||e[1]>=game.insideGridHeight)return!0;for(var i=1;i<this.body.length;++i)if(this.body[i][0]===e[0]&&this.body[i][1]===e[1])return!0;for(var t=0;t<game.historySnakes.length;++t){var a=game.historySnakes[t].items[this.totalFrames];if(a)for(i=0;i<a.length;++i)if(a[i][0]===e[0]&&a[i][1]===e[1])return!0}return!1},a.prototype.speedUp=function(e){this._skipFramePeriod*=.8},a.prototype._recordHistory=function(){this.history[this.totalFrames]=this.body.slice()},a.prototype.getHistory=function(){return{keys:Object.keys(this.history).map(function(e){return parseInt(e)}),items:this.history}},window.game={status:0,round:0,snake:null,historySnakes:[],roundScore:0,gameScore:0,heartScore:3,maxHeartScore:9,ctx:null,width:800,height:500,gridSize:20,marginGrids:0,roundFrames:0,colorGrass:"#d1c4af",colorSnake:"#786f69",colorSnakeDead:"#b2a699",colorFood:"#504a4b"},game.gridWidth=game.width/game.gridSize,game.gridHeight=game.height/game.gridSize,game.insideWidth=game.width-game.marginGrids*game.gridSize*2,game.insideHeight=game.height-game.marginGrids*game.gridSize*2,game.insideGridWidth=game.insideWidth/game.gridSize,game.insideGridHeight=game.insideHeight/game.gridSize,(n=document.getElementById("main")).width=game.width,n.height=game.height,game.ctx=n.getContext("2d"),game.ctx.fillStyle=game.colorGrass,game.ctx.fillRect(game.marginGrids*game.gridSize,game.marginGrids*game.gridSize,game.insideWidth,game.insideHeight),document.addEventListener("keydown",s),o(),setTimeout(function(){game.gameScore=0,game.status=1,g()},3e3)}();